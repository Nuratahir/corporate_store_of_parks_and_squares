{% extends 'store_app/base.html' %}

{% block title %}Интернет-магазин{% endblock %}

{% block content %}
<main>
    <div class="container mt-5 text-center">
        <h1>ОПИСАНИЕ САЙТА — ......</h1>
    </div>

    <div id="products" class="container mt-5">
        <div class="row justify-content-center gap-4">
            {% for product in products %}
            <div class="product-wrapper col-md-3">
                <div class="product-card">
                    <p>{{ product.name_product }}<br>
                    <small>{{ product.price }} ₽</small></p>
                </div>

                <div class="product-control">
                    <button class="btn btn-secondary" onclick="changeCount({{ product.id }}, -1)">–</button>
                    <span id="count{{ product.id }}">0</span>
                    <button class="btn btn-secondary" onclick="changeCount({{ product.id }}, 1)">+</button>
                </div>

                <!-- ИСПРАВЛЕННАЯ КНОПКА: ФОРМА вместо ссылки -->
                <form method="post" action="{% url 'add_to_cart' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id|stringformat:'i' }}">
                    <input type="hidden" name="quantity" id="quantity{{ product.id }}" value="0">
                    <button type="submit" id="buy{{ product.id }}"
                            class="btn btn-success mt-3 disabled-btn">
                        В корзину
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
</main>

<!-- ДОБАВЬ этот script в start_page.html (или обнови base.html) -->
<script>
// Функция должна обновлять и hidden поле тоже!
function changeCount(id, delta) {
    const countEl = document.getElementById("count" + id);
    const quantityInput = document.getElementById("quantity" + id); // ← ВАЖНО!
    const btn = document.getElementById("buy" + id);

    let val = parseInt(countEl.textContent) + delta;
    if (val < 0) val = 0;

    // Обновляем видимое число
    countEl.textContent = val;
    // Обновляем hidden поле формы
    quantityInput.value = val;

    // Активируем/деактивируем кнопку
    if (val > 0) {
        btn.classList.remove("disabled-btn");
    } else {
        btn.classList.add("disabled-btn");
    }
}
</script>
{% endblock %}