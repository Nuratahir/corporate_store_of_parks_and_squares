{% extends 'store_app/base.html' %}

{% block title %}–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω{% endblock %}

{% block content %}
<main>
    <div class="container mt-5 text-center">
        <h1>–û–ü–ò–°–ê–ù–ò–ï –°–ê–ô–¢–ê ‚Äî ......</h1>
    </div>

    <div id="products" class="container mt-5">
        <div class="row justify-content-center gap-4">
            {% for product in products %}
            <div class="product-wrapper col-md-3">
                <div class="product-card">
                    <p>{{ product.name_product }}<br>
                    <small>{{ product.price }} ‚ÇΩ</small></p>
                </div>

                <div class="product-control">
                    <button class="btn btn-secondary" onclick="updateProductCount({{ product.id }}, -1)">‚Äì</button>
                    <span id="count{{ product.id }}">0</span>
                    <button class="btn btn-secondary" onclick="updateProductCount({{ product.id }}, 1)">+</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –ï–î–ò–ù–ê–Ø –ö–ù–û–ü–ö–ê –î–õ–Ø –í–°–ï–• –¢–û–í–ê–†–û–í -->
        <div class="text-center mt-5">
            <form id="addAllForm" method="post" action="{% url 'add_all_to_cart' %}">
                {% csrf_token %}
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –í–°–ï–• –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
                {% for product in products %}
                <input type="hidden" name="product_{{ product.id }}" id="product_{{ product.id }}" value="0">
                {% endfor %}

                <button type="submit" id="addAllBtn" class="btn btn-success btn-lg" disabled>
                    üõí –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É
                </button>
                <p class="text-muted mt-2" id="selectedCount">–í—ã–±—Ä–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: 0</p>
            </form>
        </div>
    </div>
</main>

<!-- JavaScript –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script>
// –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - —É–±–∏—Ä–∞–µ–º DOMContentLoaded –∏ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function updateProductCount(productId, delta) {
    console.log(`updateProductCount: ${productId}, delta: ${delta}`);

    // 1. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const countEl = document.getElementById("count" + productId);
    const hiddenInput = document.getElementById("product_" + productId);

    if (!countEl) {
        console.error(`–ù–µ –Ω–∞–π–¥–µ–Ω count${productId}`);
        return;
    }
    if (!hiddenInput) {
        console.error(`–ù–µ –Ω–∞–π–¥–µ–Ω product_${productId}`);
        return;
    }

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    let current = parseInt(countEl.textContent) || 0;
    let newCount = current + delta;
    if (newCount < 0) newCount = 0;

    countEl.textContent = newCount;
    hiddenInput.value = newCount;

    console.log(`–¢–æ–≤–∞—Ä ${productId}: –±—ã–ª–æ ${current}, —Å—Ç–∞–ª–æ ${newCount}`);

    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
    updateCartSummary();
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
function updateCartSummary() {
    let totalItems = 0;
    let totalQuantity = 0;

    // –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö hidden –ø–æ–ª–µ–π
    const hiddenInputs = document.querySelectorAll('input[id^="product_"]');

    hiddenInputs.forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            totalItems++;
            totalQuantity += qty;
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    const selectedCountEl = document.getElementById("selectedCount");
    if (selectedCountEl) {
        selectedCountEl.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${totalItems} –≤–∏–¥–∞(–æ–≤), –≤—Å–µ–≥–æ ${totalQuantity} —à—Ç.`;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
    const addAllBtn = document.getElementById("addAllBtn");
    if (addAllBtn) {
        if (totalItems > 0) {
            addAllBtn.disabled = false;
            addAllBtn.textContent = `üõí –î–æ–±–∞–≤–∏—Ç—å ${totalItems} –≤–∏–¥–∞(–æ–≤) —Ç–æ–≤–∞—Ä–æ–≤`;
        } else {
            addAllBtn.disabled = true;
            addAllBtn.textContent = "üõí –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É";
        }
    }

    console.log(`–°–≤–æ–¥–∫–∞: ${totalItems} –≤–∏–¥–æ–≤, ${totalQuantity} —à—Ç.`);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º updateCartSummary
updateCartSummary();
</script>
{% endblock %}