<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
        }

        .tab.active {
            background: white;
            border-color: #dee2e6 #dee2e6 white;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .order-item {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .badge-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .badge-ordered {
            background: #28a745;
            color: white;
        }

        .badge-cart {
            background: #ffc107;
            color: black;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
        }

        .message.user {
            background: #d1e7dd;
            margin-left: auto;
        }

        .message.admin {
            background: #cfe2ff;
            margin-right: auto;
        }

        .message strong {
            display: block;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .timestamp {
            font-size: 0.8em;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .attach-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }

        .attach-btn:hover {
            background: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="tab" onclick="showTab('orders')">
                –ú–æ–∏ –∑–∞–∫–∞–∑—ã
                {% if orders %}
                    <span class="badge bg-primary ms-1">{{ orders.count }}</span>
                {% endif %}
            </div>
            <div class="tab" onclick="showTab('chat')">–ß–∞—Ç —Å –∞–¥–º–∏–Ω–æ–º</div>
            <div style="margin-left: auto; display: flex;">
                <a href="{% url 'start_page' %}" class="tab">–í –ü–ê–†–ö–ò –ò –°–ö–í–ï–†–´</a>
                <a href="{% url 'logout' %}" class="tab text-danger">–í—ã–π—Ç–∏</a>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ "–ü—Ä–æ—Ñ–∏–ª—å" -->
        <div id="profile" class="tab-content active">
            <h3>–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è:</label>
                        <input type="text" class="form-control" value="{{ employee.first_name }}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" class="form-control" value="{{ employee.last_name }}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input type="email" class="form-control" value="{{ employee.email }}" readonly>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">–û—Ç–¥–µ–ª:</label>
                        <input type="text" class="form-control" value="{{ employee.department }}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                        <input type="text" class="form-control" value="{{ employee.position }}" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ "–ú–æ–∏ –∑–∞–∫–∞–∑—ã" -->
        <div id="orders" class="tab-content">
            <h3>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>

            {% if orders %}
                <p class="text-muted">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {{ orders.count }}</p>

                {% for order in orders %}
                <div class="order-item">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>–ó–∞–∫–∞–∑ #{{ order.id }}</h5>
                            <p class="mb-1">
                                <strong>–î–∞—Ç–∞:</strong>
                                {% if order.order_date %}
                                    {{ order.order_date|date:"d.m.Y H:i" }}
                                {% else %}
                                    –Ω–µ —É–∫–∞–∑–∞–Ω–∞
                                {% endif %}
                            </p>
                            <p class="mb-1">
                                <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                <span class="badge-status {% if order.status == 'ordered' %}badge-ordered{% else %}badge-cart{% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </p>
                            <p class="mb-1">
                                <strong>–î–ª—è:</strong>
                                {% if order.for_whom %}
                                    {{ order.for_whom }}
                                {% else %}
                                    <span class="text-muted">–Ω–µ —É–∫–∞–∑–∞–Ω–æ</span>
                                {% endif %}
                            </p>
                            <p class="mb-1">
                                <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:</strong> {{ order.items.count }}
                            </p>
                        </div>

                        <div class="col-md-4 text-end">
                            <div class="mt-3">
                                <h4 class="text-primary">{{ order.total_price|floatformat:2 }} ‚ÇΩ</h4>
                            </div>

                            <button class="btn btn-sm btn-outline-primary mt-2"
                                    onclick="showOrderDetails({{ order.id }})">
                                –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                            </button>
                        </div>
                    </div>

                    <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ -->
                    <div id="order-details-{{ order.id }}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <h6>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ:</h6>
                        {% if order.items.all %}
                            <ul class="list-group">
                                {% for item in order.items.all %}
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>{{ item.product.name_product }} √ó {{ item.quantity }}</span>
                                    <span class="text-primary">{{ item.item_total|floatformat:2 }} ‚ÇΩ</span>
                                </li>
                                {% endfor %}
                            </ul>
                            <div class="mt-2 text-end">
                                <strong>–ò—Ç–æ–≥–æ: {{ order.total_price|floatformat:2 }} ‚ÇΩ</strong>
                            </div>
                        {% else %}
                            <p class="text-muted">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

            {% else %}
                <div class="alert alert-info mt-4">
                    <h5>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
                    <p>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
                    <a href="{% url 'start_page' %}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
                </div>
            {% endif %}
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ "–ß–∞—Ç —Å –∞–¥–º–∏–Ω–æ–º" -->
        <div id="chat" class="tab-content">
    <h3 class="mb-4">üí¨ –ß–∞—Ç —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</h3>

    <div class="chat-container">
        <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div class="chat-messages" id="chat-messages">
            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ) -->
            <div class="alert alert-info mb-3">
                –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {{ chat_messages.count }}
            </div>

            {% for msg in chat_messages %}
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –û–¢ –°–û–¢–†–£–î–ù–ò–ö–ê -->
                {% if msg.message_from_user %}
                <div class="message user">
                    <strong>–í—ã:</strong>
                    {{ msg.message_from_user }}
                    <div class="timestamp">{{ msg.timestamp|time:"H:i" }} ({{ msg.timestamp|date:"d.m" }})</div>
                </div>
                {% endif %}

                <!-- –û—Ç–≤–µ—Ç –û–¢ –ê–î–ú–ò–ù–ê -->
                {% if msg.message_to_admin %}
                <div class="message admin">
                    <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</strong>
                    {{ msg.message_to_admin }}
                    <div class="timestamp">{{ msg.timestamp|time:"H:i" }} ({{ msg.timestamp|date:"d.m" }})</div>
                </div>
                {% endif %}
            {% empty %}
                <div class="text-center py-4">
                    <p class="text-muted">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                </div>
            {% endfor %}
        </div>

        <!-- –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <form method="post" action="{% url 'send_message' %}" class="chat-input-area">
            {% csrf_token %}
            <!-- –°–∫—Ä–µ–ø–∫–∞ –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –≤–∏–¥–∞) -->
            <div class="attach-btn" onclick="alert('–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤')">
                üìé
            </div>

            <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ -->
            <input type="text"
                   name="message"
                   class="form-control"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   required>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button type="submit" class="btn btn-primary" style="padding: 8px 20px;">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>

        <small class="text-muted mt-2 d-block">
            üí° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        </small>
    </div>
</div>

    <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add('active');

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
        const tabs = document.querySelectorAll('.tab');
        if (tabName === 'profile') tabs[0].classList.add('active');
        if (tabName === 'orders') tabs[1].classList.add('active');
        if (tabName === 'chat') tabs[2].classList.add('active');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
    function showOrderDetails(orderId) {
        const detailsDiv = document.getElementById('order-details-' + orderId);
        detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
    }
</script>

</body>
</html>